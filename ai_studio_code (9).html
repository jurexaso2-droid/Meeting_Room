<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Group Call - Fixed</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --primary: #6c5ce7;
            --danger: #ff7675;
            --text: #ffffff;
            --chat-width: 300px;
            --bottom-height: 140px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .login-card {
            background: var(--bg-panel); padding: 40px; border-radius: 12px;
            text-align: center; width: 90%; max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        input {
            width: 100%; padding: 12px; margin: 15px 0; background: #333;
            border: 1px solid #555; color: white; border-radius: 6px;
        }
        .btn {
            padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;
            font-weight: bold; background: var(--primary); color: white; transition: 0.2s;
        }
        .btn:hover { opacity: 0.9; }

        /* --- MAIN LAYOUT --- */
        #app-container {
            display: none; width: 100%; height: 100%;
        }

        /* LEFT: VIDEO AREA */
        .main-stage {
            flex: 1; display: flex; flex-direction: column; position: relative;
            transition: all 0.3s ease;
        }

        /* HEADER */
        .header {
            padding: 10px 20px; background: rgba(0,0,0,0.5);
            display: flex; justify-content: space-between; align-items: center;
            position: absolute; top: 0; left: 0; right: 0; z-index: 10;
        }

        /* GRID */
        #grid-container {
            flex: 1; display: flex; flex-wrap: wrap; 
            justify-content: center; align-items: center; 
            gap: 15px; padding: 60px 20px 20px 20px; overflow-y: auto;
        }

        /* INDIVIDUAL VIDEO CARDS */
        .video-card {
            position: relative;
            background: #000; border-radius: 8px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            width: 400px; max-width: 100%; aspect-ratio: 16/9;
        }

        video { width: 100%; height: 100%; object-fit: cover; background: #000; }

        /* OVERLAYS */
        .vid-overlay {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 8px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            display: flex; justify-content: space-between; align-items: center;
        }
        .user-name { font-size: 14px; font-weight: 600; text-shadow: 0 1px 2px black; }

        /* RIGHT: CHAT AREA */
        .chat-sidebar {
            width: var(--chat-width); background: var(--bg-panel);
            border-left: 1px solid #333; display: flex; flex-direction: column;
        }
        .chat-header { padding: 15px; border-bottom: 1px solid #333; font-weight: bold; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { padding: 15px; border-top: 1px solid #333; display: flex; gap: 10px; }
        
        .msg { font-size: 13px; line-height: 1.4; word-wrap: break-word; }
        .msg b { color: var(--primary); }
        .my-msg { color: #ccc; }
        .sys-msg { color: #888; font-style: italic; font-size: 12px; text-align: center; }

        /* Mobile */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .chat-sidebar { 
                position: fixed; right: -100%; top: 0; bottom: 0; z-index: 50; transition: 0.3s;
                box-shadow: -5px 0 15px rgba(0,0,0,0.5);
            }
            .chat-sidebar.open { right: 0; }
            .toggle-chat { display: block !important; }
        }
        .toggle-chat { display: none; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <h2><i class="fas fa-video"></i> Team Meeting</h2>
            <p>Enter your name to join</p>
            <input type="text" id="username" placeholder="Your Name" autocomplete="off">
            <button class="btn" style="width:100%" onclick="init()">Join Meeting</button>
        </div>
    </div>

    <!-- APP -->
    <div id="app-container">
        
        <!-- VIDEO SECTION -->
        <div class="main-stage">
            <div class="header">
                <div>
                    <span id="room-status" style="font-size:14px; color:#aaa;">Status: Connecting...</span>
                    <button class="btn" style="padding: 5px 10px; font-size: 12px; margin-left: 10px;" onclick="copyLink()">
                        <i class="fas fa-link"></i> Copy Link
                    </button>
                </div>
                <button class="btn toggle-chat" onclick="toggleChat()">
                    <i class="fas fa-comment-alt"></i>
                </button>
            </div>

            <div id="grid-container">
                <!-- Videos go here -->
            </div>
        </div>

        <!-- CHAT SECTION -->
        <div class="chat-sidebar" id="chat-sidebar">
            <div class="chat-header">
                Chat <button class="btn" style="float:right; padding:2px 8px; font-size:12px;" onclick="toggleChat()"><i class="fas fa-times"></i></button>
            </div>
            <div class="chat-messages" id="chat-box">
                <div class="sys-msg">Chat is ephemeral. Messages vanish on refresh.</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Type a message..." style="margin:0">
                <button class="btn" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const peerConfig = {
            debug: 1,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        };

        // STATE
        let peer;
        let myId;
        let myName;
        let myStream;
        let activeCalls = {}; // Keep track of calls
        let activeConns = {}; // Keep track of data connections (Chat)
        let connectedPeers = []; // List of IDs we know about

        // URL PARAMS
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room'); // The Host ID

        // --- 1. INITIALIZATION ---
        async function init() {
            const nameInput = document.getElementById('username');
            if (!nameInput.value) return alert("Please enter your name");
            myName = nameInput.value;

            // UI Switch
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';

            try {
                // Get Camera/Mic
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                
                // Initialize Peer
                peer = new Peer(undefined, peerConfig);

                peer.on('open', id => {
                    myId = id;
                    console.log("My ID: " + myId);
                    
                    // Add My Own Video
                    addVideo(myStream, myName, myId, true);

                    if (!roomId) {
                        // I AM THE HOST
                        document.getElementById('room-status').innerText = "You are the Host";
                        window.history.pushState({}, '', '?room=' + myId);
                    } else {
                        // I AM A GUEST
                        document.getElementById('room-status').innerText = "Connected as Guest";
                        connectToPeer(roomId); // Connect to Host
                    }
                });

                // INCOMING CONNECTION (Chat/Data)
                peer.on('connection', conn => {
                    setupConnection(conn);
                });

                // INCOMING CALL (Video)
                peer.on('call', call => {
                    console.log("Receiving call from: " + call.peer);
                    call.answer(myStream); // Answer with my stream
                    
                    // Wait for their stream
                    call.on('stream', userStream => {
                        const name = call.metadata?.name || "User";
                        addVideo(userStream, name, call.peer, false);
                    });

                    activeCalls[call.peer] = call;
                });

                peer.on('error', err => {
                    console.error(err);
                    alert("Connection Error: " + err.type);
                });

            } catch (error) {
                alert("Could not access camera/microphone. Please allow permissions.");
                console.error(error);
            }
        }

        // --- 2. CONNECT TO OTHERS ---
        function connectToPeer(targetId) {
            if (activeConns[targetId]) return; // Already connected

            // A. Connect Data (Chat)
            const conn = peer.connect(targetId, { metadata: { name: myName } });
            setupConnection(conn);

            // B. Connect Media (Video)
            const call = peer.call(targetId, myStream, { metadata: { name: myName } });
            call.on('stream', userStream => {
                // We don't know name yet in stream event usually, handled in handshake or metadata
                addVideo(userStream, "Participant", targetId, false);
            });
            activeCalls[targetId] = call;
        }

        // --- 3. DATA & CHAT HANDLING ---
        function setupConnection(conn) {
            activeConns[conn.peer] = conn;

            conn.on('open', () => {
                // If I am Host, send the new user the list of existing peers (Mesh Logic)
                if (!roomId && myId !== conn.peer) {
                    const peerList = Object.keys(activeConns).filter(id => id !== conn.peer);
                    if (peerList.length > 0) {
                        conn.send({ type: 'peer-list', peers: peerList });
                    }
                }
            });

            conn.on('data', data => {
                handleData(data, conn.peer);
            });

            conn.on('close', () => {
                removeVideo(conn.peer);
                delete activeConns[conn.peer];
                delete activeCalls[conn.peer];
            });
        }

        function handleData(data, senderId) {
            if (data.type === 'chat') {
                // Display received message
                addChatMessage(data.sender, data.msg);
            }
            else if (data.type === 'peer-list') {
                // Host sent us a list of other users to connect to
                data.peers.forEach(id => {
                    if (id !== myId) connectToPeer(id);
                });
            }
        }

        // --- 4. VIDEO UI FUNCTIONS ---
        function addVideo(stream, name, id, isLocal) {
            // Prevent duplicates
            if (document.getElementById(`vid-${id}`)) return;

            const card = document.createElement('div');
            card.className = 'video-card';
            card.id = `vid-${id}`;

            const vid = document.createElement('video');
            vid.srcObject = stream;
            // CRITICAL FIXES FOR BLACK SCREEN / AUDIO
            vid.autoplay = true; 
            vid.playsInline = true; 
            
            if (isLocal) {
                vid.muted = true; // Mute self to prevent echo
            } else {
                vid.muted = false; // Ensure we hear others
            }

            // Ensure video plays when data loads
            vid.onloadedmetadata = () => {
                vid.play().catch(e => console.log("Play error (usually interaction needed):", e));
            };

            const overlay = document.createElement('div');
            overlay.className = 'vid-overlay';
            overlay.innerHTML = `<span class="user-name">${isLocal ? name + " (You)" : name}</span>`;

            card.appendChild(vid);
            card.appendChild(overlay);
            document.getElementById('grid-container').appendChild(card);
        }

        function removeVideo(id) {
            const el = document.getElementById(`vid-${id}`);
            if (el) el.remove();
        }

        // --- 5. CHAT FUNCTIONS ---
        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if (!msg) return;

            // 1. Show it to myself
            addChatMessage("You", msg, true);

            // 2. Send to ALL connected peers
            Object.values(activeConns).forEach(conn => {
                if (conn.open) {
                    conn.send({ type: 'chat', msg: msg, sender: myName });
                }
            });

            input.value = '';
        }

        function addChatMessage(sender, msg, isSelf = false) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = 'msg ' + (isSelf ? 'my-msg' : '');
            div.innerHTML = `<b>${sender}:</b> ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- UTILS ---
        function copyLink() {
            const url = window.location.href.split('?')[0] + '?room=' + (roomId || myId);
            navigator.clipboard.writeText(url).then(() => {
                alert("Invite link copied to clipboard!");
            });
        }

        function toggleChat() {
            document.getElementById('chat-sidebar').classList.toggle('open');
        }

        // Allow Enter key to send
        document.getElementById('chat-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendChat();
        });
    </script>
</body>
</html>