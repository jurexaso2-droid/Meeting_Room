<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Group Call</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --primary: #6c5ce7;
            --danger: #ff7675;
            --text: #ffffff;
            --chat-width: 300px;
            --bottom-height: 140px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .login-card {
            background: var(--bg-panel); padding: 40px; border-radius: 12px;
            text-align: center; width: 90%; max-width: 400px;
        }
        input {
            width: 100%; padding: 12px; margin: 15px 0; background: #333;
            border: 1px solid #555; color: white; border-radius: 6px;
        }
        .btn {
            padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;
            font-weight: bold; background: var(--primary); color: white; transition: 0.2s;
        }
        .btn:hover { opacity: 0.9; }

        /* --- MAIN LAYOUT --- */
        #app-container {
            display: none; width: 100%; height: 100%;
        }

        /* LEFT: VIDEO AREA */
        .main-stage {
            flex: 1; display: flex; flex-direction: column; position: relative;
            transition: all 0.3s ease;
        }

        /* HEADER */
        .header {
            padding: 10px 20px; background: rgba(0,0,0,0.5);
            display: flex; justify-content: space-between; align-items: center;
            position: absolute; top: 0; left: 0; right: 0; z-index: 10;
        }

        /* VIDEO CONTAINERS */
        /* 1. Standard Grid Mode */
        #grid-container {
            flex: 1; display: flex; flex-wrap: wrap; 
            justify-content: center; align-items: center; 
            gap: 15px; padding: 60px 20px 20px 20px; overflow-y: auto;
        }

        /* 2. Pinned Mode Layout */
        .pinned-mode #grid-container {
            display: none; /* Hide normal grid */
        }

        #pinned-stage {
            display: none; /* Hidden by default */
            flex: 1; background: #000;
            justify-content: center; align-items: center;
            padding-top: 50px;
        }
        
        #bottom-filmstrip {
            display: none; /* Hidden by default */
            height: var(--bottom-height);
            background: rgba(0,0,0,0.8);
            padding: 10px;
            overflow-x: auto;
            white-space: nowrap;
            gap: 10px;
            align-items: center;
        }

        /* Show pinned elements when active */
        .pinned-mode #pinned-stage { display: flex; }
        .pinned-mode #bottom-filmstrip { display: flex; }


        /* INDIVIDUAL VIDEO CARDS */
        .video-card {
            position: relative;
            background: #000; border-radius: 8px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        /* Grid Sizing */
        #grid-container .video-card {
            width: 400px; max-width: 100%; aspect-ratio: 16/9;
        }

        /* Pinned Sizing */
        #pinned-stage .video-card {
            width: 100%; height: 100%; max-height: 85vh; aspect-ratio: auto;
        }
        #pinned-stage video { object-fit: contain; }

        /* Filmstrip Sizing */
        #bottom-filmstrip .video-card {
            display: inline-block;
            width: 200px; height: 100%; margin-right: 10px;
        }

        video { width: 100%; height: 100%; object-fit: cover; }

        /* OVERLAYS (Name, Buttons) */
        .vid-overlay {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 8px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            display: flex; justify-content: space-between; align-items: center;
        }
        .user-name { font-size: 14px; font-weight: 600; text-shadow: 0 1px 2px black; }
        
        .host-controls {
            display: flex; gap: 5px;
        }
        .icon-btn {
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px;
        }
        .icon-btn:hover { background: var(--primary); }
        .icon-btn.active { background: var(--primary); }
        .icon-btn.mute-active { background: var(--danger); }

        /* RIGHT: CHAT AREA */
        .chat-sidebar {
            width: var(--chat-width); background: var(--bg-panel);
            border-left: 1px solid #333; display: flex; flex-direction: column;
        }
        .chat-header { padding: 15px; border-bottom: 1px solid #333; font-weight: bold; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-input-area { padding: 15px; border-top: 1px solid #333; display: flex; gap: 10px; }
        
        .msg { font-size: 13px; line-height: 1.4; }
        .msg b { color: var(--primary); }
        .sys-msg { color: #888; font-style: italic; font-size: 12px; text-align: center; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .chat-sidebar { 
                position: fixed; right: -100%; top: 0; bottom: 0; z-index: 50; transition: 0.3s;
                box-shadow: -5px 0 15px rgba(0,0,0,0.5);
            }
            .chat-sidebar.open { right: 0; }
            .toggle-chat { display: block !important; }
            #bottom-filmstrip { height: 100px; }
        }
        .toggle-chat { display: none; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <h2><i class="fas fa-video"></i> Team Meeting</h2>
            <p>Enter your display name to join.</p>
            <input type="text" id="username" placeholder="e.g. Rex">
            <button class="btn" style="width:100%" onclick="joinRoom()">Join Meeting</button>
        </div>
    </div>

    <!-- APP -->
    <div id="app-container">
        
        <!-- VIDEO SECTION -->
        <div class="main-stage" id="main-stage">
            <div class="header">
                <div>
                    <span id="room-status" style="font-size:14px; color:#aaa;">Connecting...</span>
                    <button class="btn" style="padding: 5px 10px; font-size: 12px; margin-left: 10px;" onclick="copyInvite()">
                        <i class="fas fa-link"></i> Copy Link
                    </button>
                </div>
                <button class="btn toggle-chat" onclick="toggleChat()">
                    <i class="fas fa-comment-alt"></i>
                </button>
            </div>

            <!-- View 1: Normal Grid -->
            <div id="grid-container"></div>

            <!-- View 2: Pinned View -->
            <div id="pinned-stage"></div>
            <div id="bottom-filmstrip"></div>
        </div>

        <!-- CHAT SECTION -->
        <div class="chat-sidebar" id="chat-sidebar">
            <div class="chat-header">
                Chat Room <button class="icon-btn" style="float:right" onclick="toggleChat()"><i class="fas fa-times"></i></button>
            </div>
            <div class="chat-messages" id="chat-box">
                <div class="sys-msg">Welcome to the chat!</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Type a message..." style="margin:0">
                <button class="btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let peer;
        let myStream;
        let myId;
        let myName = "";
        let isHost = false;
        let pinnedPeerId = null; // The ID of the currently pinned user

        // Connections
        const peers = {}; // Call objects (video)
        const dataConns = {}; // Data connections (chat/commands)
        
        // UI Refs
        const grid = document.getElementById('grid-container');
        const pinnedStage = document.getElementById('pinned-stage');
        const filmstrip = document.getElementById('bottom-filmstrip');
        const mainStage = document.getElementById('main-stage');
        const chatBox = document.getElementById('chat-box');

        // URL Params
        const urlParams = new URLSearchParams(window.location.search);
        let hostId = urlParams.get('room');

        // --- STEP 1: JOIN ---
        function joinRoom() {
            const input = document.getElementById('username');
            if(!input.value) return alert("Name required");
            myName = input.value;
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';

            startPeer();
        }

        function startPeer() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                myStream = stream;
                
                peer = new Peer(undefined, { debug: 1 });

                peer.on('open', id => {
                    myId = id;
                    console.log('My ID:', id);

                    // Host Logic
                    if (!hostId) {
                        isHost = true;
                        hostId = id;
                        document.getElementById('room-status').innerText = "You are the Host";
                        window.history.pushState({}, '', '?room=' + id);
                        addVideo(id, myName, stream, true); // Add self
                    } else {
                        document.getElementById('room-status').innerText = "Connected as Guest";
                        addVideo(id, myName, stream, true); // Add self
                        connectToHost(hostId);
                    }
                });

                // Incoming Call (Video)
                peer.on('call', call => {
                    call.answer(stream, { metadata: { name: myName } });
                    const callerName = call.metadata?.name || "User";
                    
                    call.on('stream', userStream => {
                        if (!document.getElementById(`vid-${call.peer}`)) {
                            addVideo(call.peer, callerName, userStream);
                        }
                    });
                });

                // Incoming Data (Chat/Commands)
                peer.on('connection', conn => {
                    setupDataConnection(conn);
                });

            }).catch(err => alert("Camera error: " + err));
        }

        // --- HOST / PEER CONNECTION LOGIC ---
        function connectToHost(hId) {
            // 1. Call Host (Video)
            const call = peer.call(hId, myStream, { metadata: { name: myName } });
            call.on('stream', hostStream => {
                if(!document.getElementById(`vid-${hId}`)) addVideo(hId, "Host", hostStream);
            });

            // 2. Connect Data (Chat/Cmds)
            const conn = peer.connect(hId, { metadata: { name: myName } });
            setupDataConnection(conn);
        }

        function setupDataConnection(conn) {
            dataConns[conn.peer] = conn;

            conn.on('open', () => {
                // If I am Host, tell new user about current state (e.g. who is pinned)
                if(isHost && pinnedPeerId) {
                    conn.send({ type: 'pin-update', id: pinnedPeerId });
                }
            });

            conn.on('data', data => {
                handleData(data, conn.peer);
            });

            conn.on('close', () => {
                removeVideo(conn.peer);
                delete dataConns[conn.peer];
            });
        }

        // --- DATA HANDLING (CHAT & COMMANDS) ---
        function handleData(data, senderId) {
            switch(data.type) {
                case 'chat':
                    addChatMessage(data.sender, data.msg);
                    // If I am Host, relay chat to everyone else (basic mesh)
                    if(isHost) broadcastData(data, senderId);
                    break;
                
                case 'pin-update':
                    // Host told us to pin someone
                    updatePinLayout(data.id);
                    break;

                case 'mute-force':
                    // Host muted me
                    if(data.target === myId) {
                        myStream.getAudioTracks()[0].enabled = false;
                        alert("The host has muted you.");
                        // Optional: Tell everyone I am muted
                    }
                    break;
            }
        }

        function broadcastData(data, excludeId = null) {
            Object.values(dataConns).forEach(conn => {
                if(conn.peer !== excludeId) conn.send(data);
            });
        }

        // --- VIDEO UI GENERATION ---
        function addVideo(peerId, name, stream, isLocal = false) {
            if(document.getElementById(`vid-${peerId}`)) return;

            const card = document.createElement('div');
            card.className = 'video-card';
            card.id = `vid-${peerId}`;
            card.dataset.id = peerId; // Store ID for logic

            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            if(isLocal) video.muted = true; // Avoid feedback

            // Overlay
            const overlay = document.createElement('div');
            overlay.className = 'vid-overlay';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'user-name';
            nameSpan.innerText = isLocal ? name + " (You)" : name;

            // Host Controls
            const controls = document.createElement('div');
            controls.className = 'host-controls';

            // Only Host can see controls (or you can pin yourself locally)
            if(isHost || isLocal) {
                // Pin Button
                const pinBtn = document.createElement('button');
                pinBtn.className = 'icon-btn';
                pinBtn.innerHTML = '<i class="fas fa-thumbtack"></i>';
                pinBtn.onclick = () => togglePin(peerId);
                controls.appendChild(pinBtn);
            }

            if(isHost && !isLocal) {
                // Mute Button (Host only)
                const muteBtn = document.createElement('button');
                muteBtn.className = 'icon-btn mute-btn';
                muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                muteBtn.onclick = () => forceMuteUser(peerId);
                controls.appendChild(muteBtn);
            }

            overlay.appendChild(nameSpan);
            overlay.appendChild(controls);
            card.appendChild(video);
            card.appendChild(overlay);

            // Default: Add to Grid
            grid.appendChild(card);
            
            // If current state is pinned, refresh layout
            if(pinnedPeerId) updatePinLayout(pinnedPeerId);
        }

        function removeVideo(peerId) {
            const card = document.getElementById(`vid-${peerId}`);
            if(card) card.remove();
            
            // If pinned user left, revert to grid
            if(pinnedPeerId === peerId) {
                pinnedPeerId = null;
                updatePinLayout(null);
            }
        }

        // --- PINNING LOGIC ---
        function togglePin(id) {
            if (!isHost && id !== myId && !isHost) return; // Only Host can pin for everyone

            if (pinnedPeerId === id) {
                // Unpin
                pinnedPeerId = null;
            } else {
                // Pin new
                pinnedPeerId = id;
            }

            // Update Local
            updatePinLayout(pinnedPeerId);

            // If Host, Broadcast to everyone
            if(isHost) {
                broadcastData({ type: 'pin-update', id: pinnedPeerId });
            }
        }

        function updatePinLayout(id) {
            pinnedPeerId = id;
            const allCards = document.querySelectorAll('.video-card');

            if (!id) {
                // --- GRID MODE ---
                mainStage.classList.remove('pinned-mode');
                // Move all cards back to grid
                allCards.forEach(card => grid.appendChild(card));
            } else {
                // --- PINNED MODE ---
                mainStage.classList.add('pinned-mode');
                
                allCards.forEach(card => {
                    const cardId = card.dataset.id;
                    if (cardId === id) {
                        pinnedStage.innerHTML = ''; // Clear prev
                        pinnedStage.appendChild(card); // Move to Main
                    } else {
                        filmstrip.appendChild(card); // Move to Bottom
                    }
                });
            }
        }

        // --- MUTE LOGIC (HOST) ---
        function forceMuteUser(targetId) {
            if(!isHost) return;
            if(confirm("Mute this user for everyone?")) {
                // Send signal
                const conn = dataConns[targetId];
                if(conn) conn.send({ type: 'mute-force', target: targetId });
                
                // Mute locally too just in case
                const vidEl = document.getElementById(`vid-${targetId}`).querySelector('video');
                vidEl.muted = true;
            }
        }

        // --- CHAT LOGIC ---
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if(!msg) return;

            // 1. Show Local
            addChatMessage("You", msg);

            // 2. Send Data
            const payload = { type: 'chat', msg: msg, sender: myName };
            
            if(isHost) {
                broadcastData(payload);
            } else {
                // Send to Host, Host relays
                if(hostId && dataConns[hostId]) dataConns[hostId].send(payload);
            }

            input.value = '';
        }

        function addChatMessage(sender, msg) {
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerHTML = `<b>${sender}:</b> ${msg}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- UTILS ---
        function copyInvite() {
            const url = window.location.href.split('?')[0] + '?room=' + (hostId || myId);
            navigator.clipboard.writeText(url);
            alert("Link copied!");
        }

        function toggleChat() {
            document.getElementById('chat-sidebar').classList.toggle('open');
        }

        // Enter key for chat
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
