<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zoom Clone V3 - Chat & Photo Share</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --bg-black: #000000;
            --text: #ffffff;
            --accent-blue: #0E72ED;
            --danger: #E02828;
            --toolbar-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-black);
            color: var(--text);
            margin: 0;
            height: 100dvh; 
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a;
            display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .login-card {
            background: #242424; padding: 40px; border-radius: 12px;
            text-align: center; width: 90%; max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .zoom-btn-lg {
            background: var(--accent-blue); color: white; border: none;
            padding: 12px 20px; border-radius: 8px; font-size: 16px; font-weight: 600;
            cursor: pointer; width: 100%; margin-top: 15px;
        }
        input {
            width: 100%; padding: 12px; margin: 10px 0; background: #fff;
            border: 1px solid #ccc; border-radius: 8px; font-size: 16px; outline: none;
        }

        /* --- MAIN LAYOUT --- */
        #app-container {
            display: none; flex-direction: column; height: 100%; width: 100%;
        }

        /* TOP BAR */
        .top-bar {
            height: 40px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; background: rgba(0,0,0,0.8); position: absolute; top:0; left:0; right:0; z-index: 50;
        }
        .room-badge {
            background: #333; padding: 4px 8px; border-radius: 4px; font-size: 12px;
            display: flex; align-items: center; gap: 5px; cursor: pointer;
        }

        /* VIDEO STAGE */
        #video-stage {
            flex: 1; background: black; position: relative;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; margin-top: 40px; margin-bottom: var(--toolbar-height);
        }

        #gallery-container {
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            width: 100%; height: 100%; gap: 10px; padding: 10px; overflow-y: auto;
        }

        /* VIDEO CARDS */
        .video-card {
            position: relative; background: #1a1a1a; border-radius: 8px; overflow: hidden;
            border: 1px solid #333; aspect-ratio: 16/9;
            width: 45%; max-width: 600px; min-width: 250px;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.3s ease;
        }
        /* Mobile Portrait Optimization */
        @media (max-width: 600px) {
            .video-card { width: 100%; aspect-ratio: 4/3; }
        }

        video { width: 100%; height: 100%; object-fit: contain; background: black; }
        /* Only mirror local video if it's the camera, not if it's a photo/screen */
        .mirror { transform: scaleX(-1); }

        .name-tag {
            position: absolute; bottom: 5px; left: 5px;
            background: rgba(0,0,0,0.6); padding: 2px 8px;
            border-radius: 4px; font-size: 12px; color: white;
            pointer-events: none;
        }

        /* --- TOOLBAR --- */
        .toolbar {
            height: var(--toolbar-height); background: #1a1a1a;
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; align-items: center; justify-content: space-around;
            padding: 0 10px; z-index: 100;
            border-top: 1px solid #333;
            overflow-x: auto;
        }

        .tool-btn {
            background: transparent; border: none; color: #aaa;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; cursor: pointer; min-width: 60px; padding: 5px;
            border-radius: 8px; transition: 0.2s;
            white-space: nowrap;
        }
        .tool-btn:hover { background: #333; color: white; }
        .tool-btn i { font-size: 20px; margin-bottom: 5px; }
        .tool-btn.active i { color: var(--accent-blue); }
        .tool-btn.red-icon i { color: var(--danger); }
        
        .badge-dot {
            position: absolute; top: 5px; right: 15px; width: 8px; height: 8px;
            background: red; border-radius: 50%; display: none;
        }

        /* --- SIDEBARS (Chat & Participants) --- */
        .sidebar {
            position: fixed; right: 0; top: 0; bottom: var(--toolbar-height); width: 100%; max-width: 320px;
            background: #1a1a1a; transform: translateX(100%); transition: 0.3s; z-index: 150;
            display: flex; flex-direction: column; border-left: 1px solid #333;
        }
        .sidebar.open { transform: translateX(0); }
        
        .sidebar-header {
            padding: 15px; border-bottom: 1px solid #333; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Chat Specifics */
        #chat-history {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;
        }
        .chat-msg {
            background: #333; padding: 8px 12px; border-radius: 8px;
            max-width: 85%; word-wrap: break-word; font-size: 14px;
        }
        .chat-msg.mine { align-self: flex-end; background: var(--accent-blue); color: white; }
        .chat-msg .sender { font-size: 10px; opacity: 0.7; display: block; margin-bottom: 2px; }
        
        .chat-input-area {
            padding: 10px; border-top: 1px solid #333; display: flex; gap: 8px;
        }
        .chat-input-area input {
            flex: 1; padding: 8px; margin: 0; background: #333; border: none; color: white;
        }

        /* Hidden inputs */
        #file-input-photo { display: none; }

        /* Toast */
        #toast {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 14px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 2000;
        }
    </style>
</head>
<body>

    <!-- Hidden Processing Elements -->
    <video id="local-raw-video" autoplay playsinline muted style="display:none;"></video>
    <img id="shared-photo-img" style="display:none;" crossorigin="anonymous">
    <canvas id="broadcast-canvas" style="display:none;"></canvas>
    
    <!-- Input for Photo Sharing -->
    <input type="file" id="file-input-photo" accept="image/*">

    <!-- Login -->
    <div id="login-screen">
        <div class="login-card">
            <h2 style="color:white; margin-bottom: 5px;">Zoom Clone V3</h2>
            <p style="color:#aaa; font-size:13px; margin-bottom:20px;">Secure Video & Chat</p>
            <input type="text" id="username" placeholder="Enter Your Name" autocomplete="off">
            <button class="zoom-btn-lg" onclick="initMeeting()">Join Meeting</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container">
        
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="room-badge" onclick="copyInvite()">
                <i class="fas fa-shield-alt" style="color:#0f0;"></i> 
                <span>ID: <span id="display-room-id">...</span></span>
                <i class="far fa-copy" style="margin-left:5px;"></i>
            </div>
        </div>

        <div id="toast">Notification</div>

        <!-- Video Area -->
        <div id="video-stage">
            <div id="gallery-container"></div>
        </div>

        <!-- Bottom Toolbar -->
        <div class="toolbar">
            <button class="tool-btn" id="btn-audio" onclick="toggleAudio()">
                <i class="fas fa-microphone"></i> <span>Mute</span>
            </button>
            
            <button class="tool-btn" id="btn-video" onclick="toggleVideo()">
                <i class="fas fa-video"></i> <span>Stop Video</span>
            </button>

            <button class="tool-btn" id="btn-photo" onclick="triggerPhotoShare()">
                <i class="fas fa-image"></i> <span>Share Photo</span>
            </button>

            <div style="position:relative;">
                <button class="tool-btn" onclick="toggleSidebar('chat')">
                    <i class="fas fa-comment-dots"></i> <span>Chat</span>
                    <div class="badge-dot" id="chat-badge"></div>
                </button>
            </div>

            <button class="tool-btn" onclick="toggleSidebar('participants')">
                <i class="fas fa-users"></i> <span>Users</span>
            </button>

            <button class="tool-btn end-btn" onclick="leaveMeeting()">
                <i class="fas fa-phone-slash" style="color: var(--danger);"></i> <span style="color: var(--danger);">End</span>
            </button>
        </div>

        <!-- Chat Sidebar -->
        <div id="sidebar-chat" class="sidebar">
            <div class="sidebar-header">
                <span>In-Call Chat</span>
                <i class="fas fa-times" onclick="closeSidebar()" style="cursor:pointer"></i>
            </div>
            <div id="chat-history">
                <!-- Messages go here -->
                <div style="text-align:center; color:#666; font-size:12px; margin-top:20px;">Welcome to the chat!</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Type a message..." onkeypress="handleChatKey(event)">
                <button onclick="sendChat()" style="background:var(--accent-blue); border:none; color:white; padding:8px 15px; border-radius:4px;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- Participants Sidebar -->
        <div id="sidebar-participants" class="sidebar">
            <div class="sidebar-header">
                <span>Participants</span>
                <i class="fas fa-times" onclick="closeSidebar()" style="cursor:pointer"></i>
            </div>
            <div style="padding:10px;" id="participants-list"></div>
        </div>

    </div>

    <script>
        /* --- CONFIGURATION & STATE --- */
        let peer;
        let myId;
        let myName;
        
        // Media Sources
        let rawCamStream = null;
        let myBroadcastStream = null; // The stream sent to others (Canvas)
        
        // State Flags
        let isAudioEnabled = true;
        let isVideoEnabled = true;
        let isPhotoSharing = false;
        
        // Connections
        let peers = {}; // Data connections
        let calls = {}; // Media calls
        let peerMetadata = {}; // { id: { name } }

        /* --- DOM ELEMENTS --- */
        const canvasEl = document.getElementById('broadcast-canvas');
        const ctx = canvasEl.getContext('2d', { alpha: false });
        const rawVideoEl = document.getElementById('local-raw-video');
        const photoImgEl = document.getElementById('shared-photo-img');

        /* --- INITIALIZATION --- */
        async function initMeeting() {
            const nameInput = document.getElementById('username');
            if (!nameInput.value.trim()) return alert("Please enter your name");
            myName = nameInput.value;

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';

            try {
                // 1. Get Camera (Ask for 16:9, but accept whatever mobile gives)
                rawCamStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 640 }, height: { ideal: 360 }, facingMode: "user" }, 
                    audio: { echoCancellation: true, noiseSuppression: true } 
                });
                rawVideoEl.srcObject = rawCamStream;

                // 2. Start Canvas Engine (This mixes camera + photo)
                startCanvasCompositor();

                // 3. Create Stream from Canvas
                const canvasStream = canvasEl.captureStream(25); // 25 FPS
                // IMPORTANT: Add the microphone audio track to the canvas stream
                const audioTrack = rawCamStream.getAudioTracks()[0];
                if(audioTrack) canvasStream.addTrack(audioTrack);
                
                myBroadcastStream = canvasStream;

                // 4. Initialize PeerJS
                setupPeerConnection();

            } catch (err) {
                console.error(err);
                alert("Error accessing camera/microphone. Please allow permissions.");
                window.location.reload();
            }
        }

        /* --- CANVAS COMPOSITOR (THE ENGINE) --- */
        function startCanvasCompositor() {
            // Set canvas size
            canvasEl.width = 640;
            canvasEl.height = 360;

            function draw() {
                // Fill background
                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, canvasEl.width, canvasEl.height);

                if (isPhotoSharing) {
                    // Draw Shared Photo (Contain Mode)
                    const imgRatio = photoImgEl.naturalWidth / photoImgEl.naturalHeight;
                    const canvasRatio = canvasEl.width / canvasEl.height;
                    
                    let dw, dh, dx, dy;
                    
                    if (imgRatio > canvasRatio) {
                        dw = canvasEl.width;
                        dh = canvasEl.width / imgRatio;
                        dx = 0;
                        dy = (canvasEl.height - dh) / 2;
                    } else {
                        dh = canvasEl.height;
                        dw = canvasEl.height * imgRatio;
                        dy = 0;
                        dx = (canvasEl.width - dw) / 2;
                    }
                    ctx.drawImage(photoImgEl, dx, dy, dw, dh);

                } else if (isVideoEnabled) {
                    // Draw Camera (Mirror)
                    if (rawVideoEl.readyState === 4) {
                        ctx.save();
                        ctx.translate(canvasEl.width, 0);
                        ctx.scale(-1, 1); // Mirror effect
                        ctx.drawImage(rawVideoEl, 0, 0, canvasEl.width, canvasEl.height);
                        ctx.restore();
                    }
                } else {
                    // Video Muted Placeholder
                    ctx.fillStyle = "#222";
                    ctx.fillRect(0, 0, canvasEl.width, canvasEl.height);
                    ctx.fillStyle = "#fff";
                    ctx.font = "40px Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(myName.charAt(0).toUpperCase(), canvasEl.width/2, canvasEl.height/2);
                }

                requestAnimationFrame(draw);
            }
            draw();
        }

        /* --- PEERJS CONNECTION --- */
        function setupPeerConnection() {
            peer = new Peer(undefined, {
                debug: 1
            });

            peer.on('open', id => {
                myId = id;
                document.getElementById('display-room-id').innerText = id;
                
                // Add Local Video Card
                addVideoCard(myId, myBroadcastStream, true);

                // Check URL for room to join
                const urlParams = new URLSearchParams(window.location.search);
                const roomId = urlParams.get('room');
                if (roomId) {
                    connectToHost(roomId);
                } else {
                    // I am the host
                    const newUrl = window.location.pathname + '?room=' + id;
                    window.history.pushState({path: newUrl}, '', newUrl);
                }
            });

            peer.on('connection', handleDataConnection);
            peer.on('call', handleMediaCall);
            
            peer.on('error', err => {
                console.error("Peer Error:", err);
                if(err.type === 'peer-unavailable') {
                    alert("Room not found or host disconnected.");
                }
            });
        }

        /* --- CONNECTIVITY LOGIC --- */
        function connectToHost(hostId) {
            const conn = peer.connect(hostId, { metadata: { name: myName } });
            handleDataConnection(conn);
        }

        function handleDataConnection(conn) {
            peers[conn.peer] = conn;

            conn.on('open', () => {
                // Connection established, now call for media
                if (!calls[conn.peer]) {
                    const call = peer.call(conn.peer, myBroadcastStream, { metadata: { name: myName } });
                    handleMediaCall(call);
                }
            });

            conn.on('data', data => {
                switch(data.type) {
                    case 'chat':
                        receiveChat(conn.peer, data.message, data.senderName);
                        break;
                    case 'meta':
                        peerMetadata[conn.peer] = data.payload;
                        updateParticipantsList();
                        break;
                }
            });

            conn.on('close', () => removePeer(conn.peer));
            
            // Send my name immediately
            conn.send({ type: 'meta', payload: { name: myName } });
        }

        function handleMediaCall(call) {
            calls[call.peer] = call;
            call.answer(myBroadcastStream); // Answer with my stream

            call.on('stream', remoteStream => {
                const remoteName = call.metadata ? call.metadata.name : "User";
                peerMetadata[call.peer] = { name: remoteName };
                addVideoCard(call.peer, remoteStream, false);
                updateParticipantsList();
            });
            
            call.on('close', () => removePeer(call.peer));
            call.on('error', e => console.log('Call error', e));
        }

        function removePeer(id) {
            if (document.getElementById(`vid-${id}`)) {
                document.getElementById(`vid-${id}`).remove();
            }
            delete peers[id];
            delete calls[id];
            delete peerMetadata[id];
            updateParticipantsList();
            showToast("User left the meeting");
        }

        /* --- UI HELPERS --- */
        function addVideoCard(id, stream, isLocal) {
            if (document.getElementById(`vid-${id}`)) return;

            const card = document.createElement('div');
            card.className = 'video-card';
            card.id = `vid-${id}`;

            const vid = document.createElement('video');
            vid.srcObject = stream;
            vid.autoplay = true;
            vid.playsInline = true;
            
            // Mute local video to prevent echo
            if (isLocal) vid.muted = true;

            const name = document.createElement('div');
            name.className = 'name-tag';
            name.innerText = isLocal ? "You" : (peerMetadata[id]?.name || "Guest");

            card.appendChild(vid);
            card.appendChild(name);
            document.getElementById('gallery-container').appendChild(card);
        }

        /* --- PHOTO SHARE LOGIC --- */
        const fileInput = document.getElementById('file-input-photo');
        
        function triggerPhotoShare() {
            if (isPhotoSharing) {
                // Stop Sharing
                isPhotoSharing = false;
                document.getElementById('btn-photo').classList.remove('active');
                document.getElementById('btn-photo').querySelector('span').innerText = "Share Photo";
                showToast("Photo sharing stopped");
            } else {
                // Open File Picker
                fileInput.click();
            }
        }

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    photoImgEl.src = evt.target.result;
                    photoImgEl.onload = () => {
                        isPhotoSharing = true;
                        document.getElementById('btn-photo').classList.add('active');
                        document.getElementById('btn-photo').querySelector('span').innerText = "Stop Share";
                        showToast("Photo is being shared");
                    }
                };
                reader.readAsDataURL(file);
            }
            // Reset input so same file can be selected again
            fileInput.value = ''; 
        });

        /* --- CHAT LOGIC --- */
        function toggleSidebar(type) {
            const el = document.getElementById(`sidebar-${type}`);
            const isOpen = el.classList.contains('open');
            
            // Close all first
            document.querySelectorAll('.sidebar').forEach(s => s.classList.remove('open'));
            
            if (!isOpen) {
                el.classList.add('open');
                if(type === 'chat') {
                    document.getElementById('chat-badge').style.display = 'none';
                }
            }
        }
        
        function closeSidebar() {
            document.querySelectorAll('.sidebar').forEach(s => s.classList.remove('open'));
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') sendChat();
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            // 1. Show in my chat
            appendChatMessage("You", msg, true);

            // 2. Send to all peers
            Object.values(peers).forEach(conn => {
                if (conn.open) {
                    conn.send({ type: 'chat', message: msg, senderName: myName });
                }
            });

            input.value = '';
        }

        function receiveChat(senderId, msg, senderName) {
            const name = senderName || "Guest";
            appendChatMessage(name, msg, false);
            
            // Show notification if sidebar closed
            if (!document.getElementById('sidebar-chat').classList.contains('open')) {
                document.getElementById('chat-badge').style.display = 'block';
                showToast(`New message from ${name}`);
            }
        }

        function appendChatMessage(sender, msg, isMine) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `chat-msg ${isMine ? 'mine' : ''}`;
            div.innerHTML = `<span class="sender">${sender}</span>${escapeHtml(msg)}`;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        /* --- CONTROLS --- */
        function toggleAudio() {
            isAudioEnabled = !isAudioEnabled;
            // Toggle the track within the raw stream
            rawCamStream.getAudioTracks()[0].enabled = isAudioEnabled;
            
            const btn = document.getElementById('btn-audio');
            if (isAudioEnabled) {
                btn.classList.remove('red-icon');
                btn.querySelector('i').className = 'fas fa-microphone';
                btn.querySelector('span').innerText = "Mute";
            } else {
                btn.classList.add('red-icon');
                btn.querySelector('i').className = 'fas fa-microphone-slash';
                btn.querySelector('span').innerText = "Unmute";
            }
        }

        function toggleVideo() {
            isVideoEnabled = !isVideoEnabled;
            // We don't stop the track, we just stop drawing it in the canvas (handled in startCanvasCompositor)
            
            const btn = document.getElementById('btn-video');
            if (isVideoEnabled) {
                btn.classList.remove('red-icon');
                btn.querySelector('i').className = 'fas fa-video';
                btn.querySelector('span').innerText = "Stop Video";
            } else {
                btn.classList.add('red-icon');
                btn.querySelector('i').className = 'fas fa-video-slash';
                btn.querySelector('span').innerText = "Start Video";
            }
        }

        function updateParticipantsList() {
            const list = document.getElementById('participants-list');
            list.innerHTML = `<div style="padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
                <span>You (${myName})</span> <span style="color:#0f0">Host</span>
            </div>`;
            
            Object.keys(peerMetadata).forEach(id => {
                list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #333;">
                    ${peerMetadata[id].name || "Guest"}
                </div>`;
            });
        }

        function copyInvite() {
            const url = window.location.href.split('?')[0] + '?room=' + myId;
            navigator.clipboard.writeText(url);
            showToast("Invite Link Copied!");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }

        function leaveMeeting() {
            if(confirm("Leave Meeting?")) {
                window.location.href = window.location.pathname;
            }
        }
    </script>
</body>
</html>